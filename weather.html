<!DOCTYPE html>
<html>

<head profile="http://gmpg.org/xfn/11">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

	<title>Món Zero - 天気</title>


	<link rel="shortcut icon" href="images/favicon.png" type="image/x-icon" />
	<link rel="stylesheet" href="style.css" type="text/css" media="screen" />

</head>

<body>
	<div id="bkanji"><!-- inicia bkanji-->
		<h2 style="text-align: center;">Món Zero - 天気</h2>
		<div id="chart" style="width: 100%; height: 400px"></div>

		<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
		<script>
			google.charts.load('current', { packages: ['corechart'] })

			async function loadData() {
				const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQy1pY-secis7q5vnt3yLPAoK6OcYPSdOzC_7FqwhIVQp5hX0futRVxVHdFnBQN-vptH4YMNz7LN0UR/pub?output=csv'
				const res = await fetch(url)
				const text = await res.text()

				const rows = text.trim().split('\n').slice(1)
				const bySensor = {}
				const timestamps = new Set()

				for (const line of rows) {
					const [dateStr, sensor, tempStr] = line.split(',')
					const ts = moment(dateStr, 'DD/MM/YYYY HH:mm:ss').toDate() // fix European date
					timestamps.add(ts)
					if (!bySensor[sensor]) bySensor[sensor] = {}
					bySensor[sensor][ts] = parseFloat(tempStr)
				}
				// build header
				const sensors = Object.keys(bySensor)
				const header = ['Date', ...sensors]

				// build rows
				const sorted = [...timestamps].sort((a, b) => a - b)
				const data = [header]

				for (const ts of sorted) {
					const row = [ts]
					for (const s of sensors) {
						row.push(bySensor[s][ts] ?? null)
					}
					data.push(row)
				}

				return data

			}

			async function draw() {
				const raw = await loadData()
				const dataTable = google.visualization.arrayToDataTable(raw)

				// format X-axis values for tooltips in 24h format
				for (let i = 1; i < dataTable.getNumberOfRows(); i++) {
					const ts = dataTable.getValue(i, 0)
					dataTable.setFormattedValue(i, 0, moment(ts).format('DD/MM/YYYY HH:mm'))
				}

				const chart = new google.visualization.LineChart(document.getElementById('chart'))
				chart.draw(dataTable, {
					legend: { position: 'bottom' },
					hAxis: { format: 'dd/MM/yyyy HH:mm', title: 'Date & Time' },
					vAxis: { title: 'Temperature' },
					tooltip: { isHtml: false }
				})
			}

			google.charts.setOnLoadCallback(async () => {
				await draw()
				setInterval(draw, 5 * 60 * 1000)
			})
		</script>
		<!-- acaba bkanji-->

		<div id="peu"><!-- inicia peu-->
			<hr />
			<p>Pàgina somniada per <em>l'aldraia</em>

		</div><!-- acaba peu-->
</body>

</html>